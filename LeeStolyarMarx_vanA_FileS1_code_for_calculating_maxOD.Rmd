---
title: "Calculating max OD from multiwell plate growth data"
output:
  html_document:
    df_print: paged
---

Here is a set of functions that we used to process the growth data presented in the manusript (Lee, Stolyar, & Marx 2019). This code works best in conjunction with the Wallac Victor2 plate reader and CurveFitter (http://www.evolvedmicrobe.com/CurveFitter/). Curvefitter will take the data spreadsheets generated by the Victor2 for each timepoint and assemble them into a single data summary for each plate. See File S2 for the summary sheet containing the data used in the manuscript.


Set the working directory to wherever you have stored the unzipped data files. Load the necessary libraries. 
```{r setup}
knitr::opts_knit$set(root.dir = 'FileS2_growthdata')
library(reshape2) 
library(ggplot2)
library(RColorBrewer)
library(DescTools)
```


Read in a metadata spreadsheet identifying the contents of each well in each plate, then read in the OD data spreadsheets, one per plate (each plate is a different species). These spreadsheets are the output from CurveFitter.

```{r}
well_IDs<-read.csv('growthsubstrates_wellIDs.csv', header=T) 
AMS5<-read.csv('AMS5.csv', header=T)
M446<-read.csv('M446.csv', header=T)
MA22A<-read.csv('MA22A.csv', header=T)
Maq<-read.csv('Maq.csv', header=T)
Mnod<-read.csv('Mnod.csv', header=T)
Mplat<-read.csv('Mplat.csv', header=T)
Mtar<-read.csv('Mtar.csv', header=T)
Mvar<-read.csv('Mvar.csv', header=T)
```

The following function will use the blank wells in each plate to normalize the data wells. It calculates the blank value for each culture medium separately, as some media are colored.

```{r}
subtractblank<-function(v1, v2) (v1-v2)
blank_plate<-function(platename){
  plate_df<-platename
  blanked_df<-plate_df
  blanked_df[,2:dim(blanked_df)[2]]<-'NA'
  for (med in unique(well_IDs$substrate)){
    blankwells<-subset(well_IDs, type=='blank' & substrate==med)$well
    blankvals<-rowMeans(as.matrix(plate_df[,which(colnames(plate_df) %in% blankwells)]))
    wells_to_blank<-subset(well_IDs, type=='growth' & substrate==med)$well
    blanked_df[,which(colnames(plate_df) %in% wells_to_blank)]<-lapply(plate_df[,which(colnames(plate_df) %in% wells_to_blank)], subtractblank, v2=blankvals)
  }
  return(blanked_df)
}
```

The following function converts a dataframe into long format, and converts the Time to equal the time elapsed since the start of the experiment.
```{r}
melt_plate<-function(dataframe, sp){
  dataframe<-melt(dataframe, id.vars='Time', variable.name='well', value.name='OD')
  dataframe$Time<-as.POSIXct(dataframe$Time, format='%m/%d/%Y %I:%M:%S %p')
  Timepoints<-as.numeric(difftime(dataframe$Time, min(dataframe$Time))/3600) 
  dataframe$Time<-Timepoints
  dataframe$species<-sp
  return(dataframe)
}
```

Here, we use the "blank plate" and "melt plate" functions on the dataset from each culture plate:
```{r}
AMS5<-subset(melt_plate(blank_plate(AMS5), 'M_sp_AMS-5'), OD!='NA')
M446<-subset(melt_plate(blank_plate(M446), 'M_sp_4-46'), OD!='NA')
MA22A<-subset(melt_plate(blank_plate(MA22A), 'M_sp_MA-22A'), OD!='NA')
Maq<-subset(melt_plate(blank_plate(Maq), 'M_aquaticum'), OD!='NA')
Mnod<-subset(melt_plate(blank_plate(Mnod), 'M_nodulans'), OD!='NA')
Mplat<-subset(melt_plate(blank_plate(Mplat), 'M_platani'), OD!='NA')
Mtar<-subset(melt_plate(blank_plate(Mtar), 'M_tarhaniae'), OD!='NA')
Mvar<-subset(melt_plate(blank_plate(Mvar), 'M_variabile'), OD!='NA')
```

Then we merge all dataframes into one big dataframe for all species, called "Growth," and clean up the environment.
```{r}
Growth<-rbind(AMS5, M446, MA22A, Maq, Mnod, Mplat, Mtar, Mvar)
Growth<-merge(Growth, well_IDs, by='well') 
Growth$column<-factor(Growth$column)
Growth$OD<-as.numeric(Growth$OD)
Growth$species<-factor(Growth$species)

rm(AMS5, M446, MA22A, Maq, Mnod, Mplat, Mtar, Mvar, well_IDs, melt_plate, blank_plate, subtractblank)
```


The following chunks allow inspection and removal of outliers. 

Here is a short function to simplify plotting all the data for a single species.

```{r}
plot_species_growth<-function(spec){
  plot_spec<-ggplot(data=subset(Growth, species==spec), 
                                  aes(x=Time, y=OD, color=column, pch=row, group=well)) +
    geom_line(size=1) + geom_point(size=2) +
    theme_bw() + ggtitle(eval(spec)) + xlab('Time (hours)') 
  return(plot_spec)
}
```

For example, use the above function to look at species #5:
```{r}
plot_species_growth(levels(Growth$species)[5])
```

Remove the outliers:
```{r}
Growth<-subset(Growth, !(species=='M_sp_AMS-5' & Time>17 & Time<18 
                         & well %in% c('D3','C5')))
Growth<-subset(Growth, !(species=='M_sp_AMS-5' & Time>50 & Time<52 & well=='B6'))
Growth<-subset(Growth, !(species=='M_sp_AMS-5' & Time>4 & Time<5))

plot_species_growth(levels(Growth$species)[5])
```


This function calculates the maximum OD for each species/substrate combination in the Growth dataframe.
```{r}
calc_maxOD<-function(sp, sub){
  df1<-Growth[Growth$species==sp & Growth$substrate==sub,]
  wells<-unique(df1$well)
  maxODs<-data.frame()
  for (wellnum in wells){
    df2<-df1[df1$well==wellnum,]
    mo1<-max(df2$OD)
    mo2<-sort(df2$OD, decreasing=T)[2]
    mo3<-sort(df2$OD, decreasing=T)[3]
    mo<-mean(mo1, mo2, mo3)
    maxODs<-rbind(maxODs, data.frame(species=sp, substrate=sub, well=wellnum, max_OD=mo))
  }
  return(maxODs)
}
```


We then use that function in a loop through each species/substrate combination, and complile the results into the dataframe "Methylobacterium_sp_maxODs".
```{r}
Methylobacterium_sp_maxODs<-data.frame()
for (species in levels(Growth$species)){
  for (substrate in levels(Growth$substrate)){
    Methylobacterium_sp_maxODs<-rbind(Methylobacterium_sp_maxODs, calc_maxOD(species, substrate))
  }
}

head(Methylobacterium_sp_maxODs)
```



